<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD7mrPd_JFePxDLA4YifSaYfCsZHCZ7V-E",
      authDomain: "grow-3e3a1.firebaseapp.com",
      databaseURL: "https://grow-3e3a1-default-rtdb.firebaseio.com",
      projectId: "grow-3e3a1"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Function to generate random 6-char referral code
    function generateReferralCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code = '';
      for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    function registerUser() {
      const phone = document.getElementById("phone").value.trim();
      const name = document.getElementById("name").value.trim();
      const password = document.getElementById("password").value.trim();
      const confirmPassword = document.getElementById("confirmPassword").value.trim();
      const referralCodeInput = document.getElementById("referralCode").value.trim();

      if (!phone || !name || !password || !confirmPassword) {
        alert("❌ सभी जानकारी भरें");
        return;
      }
      if (password !== confirmPassword) {
        alert("❌ पासवर्ड मैच नहीं कर रहा");
        return;
      }

      const fakeEmail = phone + "@example.com";
      auth.createUserWithEmailAndPassword(fakeEmail, password)
        .then(userCredential => {
          const user = userCredential.user;
          const myReferralCode = generateReferralCode(); // ✅ short code

          // Save new user data
          db.ref("users/" + user.uid).set({
            name: name,
            phone: phone,
            email: fakeEmail,
            referralCode: myReferralCode,
            referredBy: referralCodeInput,
            createdAt: Date.now(),
            wallet: { recharge: 0, bonus: 0, winning: 0, total: 0 },
            referralCount: 0,
            referralEarnings: 0
          }).then(() => {
            if (referralCodeInput !== "") {
              const bonusAmount = 50;
              const memberData = {
                name: name,
                joinedAt: Date.now(),
                earnings: 0,
                status: "active"
              };

              // 1. Save in user's referrals node
              db.ref("users/" + referralCodeInput + "/referrals/" + user.uid).set(true);

              // 2. Save in global referrals list
              db.ref("referrals/" + referralCodeInput + "/" + user.uid).set(memberData);

              // 3. Increase referral count
              db.ref("users/" + referralCodeInput + "/referralCount")
                .transaction(count => (count || 0) + 1);

              // 4. Increase referral earnings
              db.ref("users/" + referralCodeInput + "/referralEarnings")
                .transaction(earnings => (earnings || 0) + bonusAmount);

              // 5. Add bonus to wallet
              db.ref("users/" + referralCodeInput + "/wallet").once("value").then(snapshot => {
                let wallet = snapshot.val() || { recharge: 0, bonus: 0, winning: 0, total: 0 };
                wallet.bonus += bonusAmount;
                wallet.total += bonusAmount;
                db.ref("users/" + referralCodeInput + "/wallet").set(wallet);
              });
            }

            alert("✅ Registration successful!");
            window.location.href = "index.html";
          });
        })
        .catch(error => {
          alert("❌ " + error.message);
        });
    }
  </script>
</body>
</html>
