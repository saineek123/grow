<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recharge - Step by Step</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    /* --- simplified CSS adapted from original file for clarity --- */
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }
    body { background: #0a1026; color: #fff; min-height: 100vh; display:flex; align-items:center; justify-content:center; padding:20px; }
    .container { max-width:900px; width:100%; }
    .card { border-radius:16px; overflow:hidden; background:linear-gradient(145deg,#0c2952,#07102a); border:1px solid rgba(249,168,37,0.08); }
    .card-header { padding:26px; background:rgba(0,0,0,0.12); position:relative; }
    .card-header h1 { font-size:24px; background:linear-gradient(90deg,#f9a825,#ffca28); -webkit-background-clip:text; color:transparent; }
    .recharge-steps{display:flex;justify-content:space-between;margin-top:18px;gap:12px}
    .step{display:flex;flex-direction:column;align-items:center;width:22%}
    .step-icon{width:44px;height:44px;border-radius:999px;background:rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center}
    .step.active .step-icon{background:linear-gradient(135deg,#f9a825,#2a5298);color:#fff}
    .step-label{font-size:13px;color:#bbb;margin-top:8px;text-align:center}
    .card-body{padding:22px}

    /* HIDE non-active sections so user sees only current step */
    .form-section { display: none; }
    .form-section.active { display: block; animation: fadeIn 160ms ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

    .form-group{margin-bottom:18px}
    label{display:block;margin-bottom:8px;color:#f9a825;font-weight:600}
    .input-with-icon{position:relative}
    .input-with-icon i{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:#f9a825}
    .form-control{width:100%;padding:12px 14px 12px 46px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(10,16,38,0.5);color:#fff}

    .amount-options{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .amount-option{padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);cursor:pointer;text-align:center}
    .amount-option.selected{border-color:#f9a825;background:rgba(249,168,37,0.08)}

    .btn{padding:12px 16px;border-radius:10px;border:none;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,#f9a825,#ffca28);color:#000;font-weight:700}
    .btn-outline{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}

    .qr-container{display:none;text-align:center;margin:18px 0}
    .qr-container.visible{display:block}
    .qr-placeholder{width:260px;height:260px;margin:0 auto;border-radius:12px;background:rgba(0,0,0,0.12);display:flex;align-items:center;justify-content:center}

    .file-upload{border:2px dashed rgba(255,255,255,0.06);padding:18px;border-radius:10px;text-align:center;cursor:pointer}
    .file-name{margin-top:12px;color:#ccc}

    .status-card{padding:18px;border-radius:12px;background:rgba(0,0,0,0.08);margin-top:12px}
    .transaction-history{margin-top:16px}
    .history-item{display:flex;justify-content:space-between;padding:12px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:10px}

    .notification{position:fixed;right:20px;bottom:20px;background:rgba(0,0,0,0.8);padding:12px;border-radius:10px;border-left:4px solid #f9a825}

    @media(max-width:720px){.amount-options{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>

<body>
  <div class="container">
    <div class="card">
      <div class="card-header">
        <h1>Recharge Your Wallet - Step by Step</h1>
        <p style="color:#ccc;margin-top:6px">Follow these steps: choose amount → scan & pay → upload UTR & submit</p>

        <div class="recharge-steps">
          <div class="step" id="step1-indicator">
            <div class="step-icon"><i class="fas fa-rupee-sign"></i></div>
            <div class="step-label">Enter Amount</div>
          </div>
          <div class="step" id="step2-indicator">
            <div class="step-icon"><i class="fas fa-qrcode"></i></div>
            <div class="step-label">Scan & Pay</div>
          </div>
          <div class="step" id="step3-indicator">
            <div class="step-icon"><i class="fas fa-receipt"></i></div>
            <div class="step-label">Upload UTR</div>
          </div>
          <div class="step" id="step4-indicator">
            <div class="step-icon"><i class="fas fa-check-circle"></i></div>
            <div class="step-label">Confirmation</div>
          </div>
        </div>
      </div>

      <div class="card-body">
        <!-- STEP 1 -->
        <div class="form-section active" id="step1">
          <div class="form-group">
            <label for="amount">Enter Recharge Amount (₹)</label>
            <div class="input-with-icon">
              <i class="fas fa-rupee-sign"></i>
              <input type="number" id="amount" class="form-control" min="100" value="500" />
            </div>
          </div>

          <div class="form-group">
            <label>Quick amounts</label>
            <div class="amount-options">
              <div class="amount-option" data-amount="500">₹500<br><small>+ ₹50 bonus</small></div>
              <div class="amount-option" data-amount="1000">₹1000<br><small>+ ₹50 bonus</small></div>
              <div class="amount-option" data-amount="2000">₹2000<br><small>+ ₹150 bonus</small></div>
              <div class="amount-option" data-amount="5000">₹5000<br><small>+ ₹500 bonus</small></div>
              <div class="amount-option" data-amount="10000">₹10000<br><small>+ ₹1200 bonus</small></div>
              <div class="amount-option" data-amount="20000">₹20000<br><small>+ ₹3000 bonus</small></div>
            </div>
          </div>

          <div style="display:flex;gap:10px;margin-top:8px">
            <button class="btn btn-outline" id="cancelBtn"><i class="fas fa-times"></i> Cancel</button>
            <button class="btn btn-primary" id="nextStep1"><i class="fas fa-arrow-right"></i> Continue</button>
          </div>
        </div>

        <!-- STEP 2: QR -->
        <div class="form-section" id="step2">
          <div class="qr-container" id="qrContainer">
            <div class="qr-placeholder">
              <img id="qrImg" src="https://api.qrserver.com/v1/create-qr-code/?size=260x260&data=upi://pay?pa=grow@examplebank&pn=Grow%20Investment&am=500&cu=INR" alt="QR" />
            </div>
            <p style="margin-top:10px;color:#ccc">Scan this QR with your UPI app. Amount: <strong id="qrAmount">₹500</strong></p>
          </div>

          <div style="margin:10px 0;padding:12px;border-radius:10px;background:rgba(255,255,255,0.02)">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="color:#aaa">UPI ID</div>
                <div style="color:#f9a825;font-weight:700">grow@examplebank</div>
              </div>
              <div>
                <button class="btn btn-outline" onclick="copyToClipboard('grow@examplebank')"><i class="fas fa-copy"></i> Copy</button>
              </div>
            </div>
            <div style="margin-top:8px;color:#ccc;font-size:13px">After payment, note down the UTR/txn id and press "I have paid" to continue.</div>
          </div>

          <div style="display:flex;gap:10px;margin-top:12px">
            <button class="btn btn-outline" id="prevStep2"><i class="fas fa-arrow-left"></i> Back</button>
            <button class="btn btn-primary" id="paidBtn"><i class="fas fa-check"></i> I have paid</button>
          </div>
        </div>

        <!-- STEP 3: upload -->
        <div class="form-section" id="step3">
          <div class="form-group">
            <label>Upload UTR / Payment Screenshot</label>
            <div class="file-upload" id="fileUploadArea">
              <i class="fas fa-cloud-upload-alt" style="font-size:28px;color:#f9a825"></i>
              <p style="color:#ccc;margin-top:8px">Click to choose file or drag & drop (image/pdf)</p>
              <input type="file" id="fileInput" accept="image/*,application/pdf" style="display:none" />
              <div class="file-name" id="fileName">No file chosen</div>
            </div>
          </div>

          <div class="form-group">
            <label for="utr">UTR / Transaction ID</label>
            <div class="input-with-icon">
              <i class="fas fa-receipt"></i>
              <input type="text" id="utr" class="form-control" placeholder="Enter UTR number" />
            </div>
          </div>

          <div class="form-group">
            <label for="note">Note (optional)</label>
            <textarea id="note" class="form-control" rows="3" placeholder="Additional info (optional)"></textarea>
          </div>

          <div style="display:flex;gap:10px;margin-top:8px">
            <button class="btn btn-outline" id="prevStep3"><i class="fas fa-arrow-left"></i> Back</button>
            <button class="btn btn-primary" id="submitRecharge"><i class="fas fa-paper-plane"></i> Submit Recharge Request</button>
          </div>
        </div>

        <!-- STEP 4: Confirmation -->
        <div class="form-section" id="step4">
          <div class="status-card status-pending">
            <div style="display:flex;align-items:center;gap:12px">
              <div style="width:64px;height:64px;border-radius:999px;background:rgba(249,168,37,0.12);display:flex;align-items:center;justify-content:center;font-size:28px;color:#f9a825"><i class="fas fa-clock"></i></div>
              <div>
                <h3 style="margin-bottom:6px;color:#f9a825">Recharge Request Submitted</h3>
                <div style="color:#ccc">Your request is pending admin approval. Funds will be credited after approval.</div>
              </div>
            </div>

            <div style="margin-top:12px;background:rgba(255,255,255,0.02);padding:12px;border-radius:8px">
              <div style="display:flex;justify-content:space-between;margin-bottom:6px"><div style="color:#aaa">Transaction ID</div><div id="confirmation-id" style="color:#f9a825">-</div></div>
              <div style="display:flex;justify-content:space-between;margin-bottom:6px"><div style="color:#aaa">Amount</div><div id="confirmation-amount" style="color:#f9a825">-</div></div>
              <div style="display:flex;justify-content:space-between;margin-bottom:6px"><div style="color:#aaa">Bonus</div><div id="confirmation-bonus" style="color:#f9a825">-</div></div>
              <div style="display:flex;justify-content:space-between;margin-bottom:6px"><div style="color:#aaa">UTR</div><div id="confirmation-utr" style="color:#f9a825">-</div></div>
              <div style="display:flex;justify-content:space-between"><div style="color:#aaa">Date & Time</div><div id="confirmation-date" style="color:#f9a825">-</div></div>
            </div>

            <div style="display:flex;gap:10px;margin-top:12px">
              <button class="btn btn-outline" id="newRecharge"><i class="fas fa-plus-circle"></i> New Recharge</button>
              <button class="btn btn-primary" id="goToDashboard"><i class="fas fa-home"></i> Go to Dashboard</button>
            </div>

            <div class="transaction-history">
              <h4 style="color:#f9a825;margin-top:12px">Recent Recharge History</h4>
              <div id="rechargeHistory"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    // ---------- FIREBASE CONFIG (keep your project's values) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyD7mrPd_JFePxDLA4YifSaYfCsZHCZ7V-E",
      authDomain: "grow-3e3a1.firebaseapp.com",
      databaseURL: "https://grow-3e3a1-default-rtdb.firebaseio.com",
      projectId: "grow-3e3a1",
      storageBucket: "grow-3e3a1.appspot.com",
      messagingSenderId: "285304522946",
      appId: "1:285304522946:web:c423e49a8e0968ce63535b"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    // DOM refs
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const step4 = document.getElementById('step4');

    const step1Indicator = document.getElementById('step1-indicator');
    const step2Indicator = document.getElementById('step2-indicator');
    const step3Indicator = document.getElementById('step3-indicator');
    const step4Indicator = document.getElementById('step4-indicator');

    const amountInput = document.getElementById('amount');
    const amountOptions = document.querySelectorAll('.amount-option');

    const nextStep1Btn = document.getElementById('nextStep1');
    const prevStep2Btn = document.getElementById('prevStep2');
    const paidBtn = document.getElementById('paidBtn');
    const prevStep3Btn = document.getElementById('prevStep3');
    const submitRechargeBtn = document.getElementById('submitRecharge');
    const newRechargeBtn = document.getElementById('newRecharge');
    const goToDashboardBtn = document.getElementById('goToDashboard');
    const cancelBtn = document.getElementById('cancelBtn');

    const fileInput = document.getElementById('fileInput');
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileName = document.getElementById('fileName');
    const utrInput = document.getElementById('utr');
    const noteInput = document.getElementById('note');

    const qrContainer = document.getElementById('qrContainer');
    const qrImg = document.getElementById('qrImg');
    const qrAmount = document.getElementById('qrAmount');

    const confirmationId = document.getElementById('confirmation-id');
    const confirmationAmount = document.getElementById('confirmation-amount');
    const confirmationBonus = document.getElementById('confirmation-bonus');
    const confirmationUtr = document.getElementById('confirmation-utr');
    const confirmationDate = document.getElementById('confirmation-date');

    let selectedAmount = parseInt(amountInput.value || 500);
    let userId = null;

    // Auth check
    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        userId = user.uid;
        loadRechargeHistory();
      } else {
        // redirect to login if required
        // window.location.href = 'login.html';
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      // Amount quick picks
      amountOptions.forEach(opt => {
        opt.addEventListener('click', function () {
          amountOptions.forEach(o => o.classList.remove('selected'));
          this.classList.add('selected');
          selectedAmount = parseInt(this.dataset.amount, 10);
          amountInput.value = selectedAmount;
          if (step2.classList.contains('active')) updateQRCode();
        });
      });

      // default selection
      amountOptions[0].classList.add('selected');

      amountInput.addEventListener('input', function () {
        selectedAmount = parseInt(this.value, 10) || 0;
        amountOptions.forEach(o => o.classList.remove('selected'));
        if (step2.classList.contains('active')) updateQRCode();
      });

      // file input
      fileUploadArea.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', function () {
        if (this.files && this.files[0]) {
          fileName.textContent = this.files[0].name;
        } else {
          fileName.textContent = 'No file chosen';
        }
      });

      // drag & drop (optional)
      fileUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); fileUploadArea.style.borderColor = '#f9a825'; });
      fileUploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); fileUploadArea.style.borderColor = 'rgba(255,255,255,0.06)'; });
      fileUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        const f = e.dataTransfer.files[0];
        if (f) {
          fileInput.files = e.dataTransfer.files; // set files
          fileName.textContent = f.name;
        }
      });

      // buttons
      nextStep1Btn.addEventListener('click', () => {
        if (!selectedAmount || selectedAmount < 100) { showNotification('Minimum recharge amount is ₹100', 'error'); return; }
        updateQRCode();
        // show only step 2
        step1.classList.remove('active'); step2.classList.add('active');
        setStepIndicator(2);
        // scroll to top of card so new step is visible on small screens
        document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
      });

      prevStep2Btn.addEventListener('click', () => { step2.classList.remove('active'); step1.classList.add('active'); setStepIndicator(1); document.querySelector('.card').scrollIntoView({ behavior: 'smooth' }); });

      paidBtn.addEventListener('click', () => {
        // user confirms payment and proceeds to upload UTR
        step2.classList.remove('active'); step3.classList.add('active');
        setStepIndicator(3);
        document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
      });

      prevStep3Btn.addEventListener('click', () => { step3.classList.remove('active'); step2.classList.add('active'); setStepIndicator(2); document.querySelector('.card').scrollIntoView({ behavior: 'smooth' }); });

      submitRechargeBtn.addEventListener('click', submitRecharge);
      newRechargeBtn.addEventListener('click', resetForm);
      goToDashboardBtn.addEventListener('click', () => window.location.href = 'index.html');
      cancelBtn.addEventListener('click', () => window.location.href = 'index.html');

      // initial state
      setStepIndicator(1);
    });

    function setStepIndicator(step) {
      const steps = [step1Indicator, step2Indicator, step3Indicator, step4Indicator];
      steps.forEach((s, idx) => { if (idx === step - 1) s.classList.add('active'); else s.classList.remove('active'); });
    }

    function updateQRCode() {
      qrAmount.textContent = `₹${(selectedAmount || 0).toLocaleString('en-IN')}`;
      const upiUri = `upi://pay?pa=grow@examplebank&pn=${encodeURIComponent('Grow Investment')}&am=${selectedAmount}&cu=INR`;
      qrImg.src = 'https://api.qrserver.com/v1/create-qr-code/?size=260x260&data=' + encodeURIComponent(upiUri);
      qrContainer.classList.add('visible');
    }

    async function submitRecharge() {
      const utr = utrInput.value.trim();
      if (!utr) { showNotification('Please enter UTR / transaction id', 'error'); return; }
      if (!fileInput.files[0]) { showNotification('Please upload payment proof', 'error'); return; }

      submitRechargeBtn.disabled = true;
      submitRechargeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

      const transactionId = 'TX' + Date.now();

      try {
        // calculate bonus
        let bonus = 0;
        if (selectedAmount >= 1000 && selectedAmount < 2000) bonus = 50;
        else if (selectedAmount >= 2000 && selectedAmount < 5000) bonus = 150;
        else if (selectedAmount >= 5000 && selectedAmount < 10000) bonus = 500;
        else if (selectedAmount >= 10000) bonus = 1200;

        // upload file to storage
        const file = fileInput.files[0];
        const storageRef = storage.ref().child(`rechargeProofs/${userId}/${transactionId}/${file.name}`);
        await storageRef.put(file);
        const proofUrl = await storageRef.getDownloadURL();

        // prepare data
        const rechargeData = {
          userId: userId,
          amount: selectedAmount,
          bonus: bonus,
          utr: utr,
          note: noteInput.value.trim() || '',
          status: 'pending',
          transactionId: transactionId,
          proofUrl: proofUrl,
          createdAt: firebase.database.ServerValue.TIMESTAMP
        };

        await db.ref('rechargeRequests').push(rechargeData);

        // fill confirmation
        confirmationId.textContent = transactionId;
        confirmationAmount.textContent = `₹${selectedAmount.toLocaleString('en-IN')}.00`;
        confirmationBonus.textContent = `₹${bonus.toLocaleString('en-IN')}.00`;
        confirmationUtr.textContent = utr;
        confirmationDate.textContent = new Date().toLocaleString('en-IN', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) + ' IST';

        step3.classList.remove('active'); step4.classList.add('active'); setStepIndicator(4);
        showNotification('Recharge request submitted successfully!', 'success');
        loadRechargeHistory();
      } catch (err) {
        console.error(err);
        showNotification('Error submitting recharge: ' + (err.message || err), 'error');
      } finally {
        submitRechargeBtn.disabled = false;
        submitRechargeBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Recharge Request';
      }
    }

    async function loadRechargeHistory() {
      const historyContainer = document.getElementById('rechargeHistory');
      historyContainer.innerHTML = '<div style="color:#ccc;padding:8px">Loading...</div>';

      try {
        if (!userId) { historyContainer.innerHTML = '<div style="color:#ccc">Not logged in</div>'; return; }
        const snapshot = await db.ref('rechargeRequests').orderByChild('userId').equalTo(userId).limitToLast(10).once('value');
        if (!snapshot.exists()) { historyContainer.innerHTML = '<div style="color:#ccc">No history found</div>'; return; }

        const arr = [];
        snapshot.forEach(child => arr.push(child.val()));
        arr.reverse(); // newest first
        historyContainer.innerHTML = '';
        arr.forEach(data => {
          const date = new Date(data.createdAt || Date.now());
          const formatted = date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
          const statusClass = data.status === 'approved' ? 'Approved' : data.status === 'rejected' ? 'Rejected' : 'Pending';
          const div = document.createElement('div');
          div.className = 'history-item';
          div.innerHTML = `<div><div style="font-weight:700">₹${(data.amount||0).toLocaleString('en-IN')}</div><div style="color:#aaa;font-size:13px">${formatted}</div></div><div style="font-weight:700;color:#f9a825">${statusClass}</div>`;
          historyContainer.appendChild(div);
        });

      } catch (err) {
        console.error('History load error', err);
        historyContainer.innerHTML = '<div style="color:#f44336">Error loading history</div>';
      }
    }

    function resetForm() {
      amountInput.value = '500'; selectedAmount = 500; amountOptions.forEach(o => o.classList.remove('selected')); amountOptions[0].classList.add('selected');
      utrInput.value = ''; noteInput.value = ''; fileInput.value = ''; fileName.textContent = 'No file chosen';
      step4.classList.remove('active'); step1.classList.add('active'); setStepIndicator(1); qrContainer.classList.remove('visible');
      document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
    }

    function showNotification(message, type = 'info') {
      const exists = document.querySelector('.notification'); if (exists) exists.remove();
      const n = document.createElement('div'); n.className = 'notification'; n.textContent = message; document.body.appendChild(n);
      setTimeout(() => n.style.opacity = '1', 10);
      setTimeout(() => { n.style.opacity = '0'; setTimeout(() => n.remove(), 300); }, 3000);
    }

    function copyToClipboard(text) {
      navigator.clipboard?.writeText(text).then(() => showNotification('Copied to clipboard', 'success')).catch(() => showNotification('Copy failed', 'error'));
    }

  </script>
</body>

</html>
